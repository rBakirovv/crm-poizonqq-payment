# Подключение оплаты 
Приходится писать док-ю в блокноте из-за ограниченности во времени и ресурсах 
## Стек
Бэк: Node.js + Express.js + Mongo.DB

Фронт: Next.js + Mobx
## Ключевая структура
### crm-poizzon-api
```
├── controllers - обработка запросов
  ├── payHandlerOnePay.js - сюда приходит подтверждение об оплате. Этот код подтверждает его и меняет статус в заказе. Там же происходит проверка на сплит, на экспресс-доставку. В зависимости от суммы оплаты, пример можно посмотреть в этом файлике
  ├── payOnePay.js - создание платежных ссылок, просмотр информации и т.д. Работает как прокси. С клиента прилетает запрос на сервер, сервер обрабатывает данные и просит у платежки создать ссылки
├── routes - пути, на которые должны приходить запрос 
├── models - модели 
```
### crm-poizon-front
```
├── src
  ├── components - реакт-компоненты
  ├── store - файлы стейт-менеджера MobX
  ├── types - интерфейсы TypeScript
  ├── utils - запросы к API, примеры можно посмотреть в PaySystem.ts 
```
## Бэк
Алгоритм:
- __.env__ поместить в корень
- По примеру __payOnePay.js__ создать платежные ссылки, добавить возможность запрашивать статус оплаты
- По примеру __payHandlerOnePay__ разработать систему принятия платежа 
## Фронт
Алгоритм: 
- __.env.local__ поместить в корень
- При создании заказа создавать запросы на создание ссылок. На фронте, __src/components/CreateOrder__ есть метод __handleSubmitCreate()__. Он харкодный, ссылок создается много, очень важно правильно указывать сумму (сплит, полная оплата). Если по нему возникнут вопросы, а они обязательно будут - можно задать их мне 
- Заказ создан, ссылки тоже. Успех! Теперь нужно создавать ссылки во вкладке проверки оплаты (это нужно на тот случай, если ссылки необходимо пересоздать). На фронте, __src/components/AcceptPayment__, метод __handlePayLinkSubmit()__ и т.д (честно, не помню, может быть там есть методы для спплита и экспресс-доставки). Еще на этой странице есть модальные окна подтверждения и аккордеоны. Поэтому придется немного разобраться
- Некст. Нужно вывести кнопочки на странице клиента. На фронте, __src/components/Order__, методы __payLinkRedirect()__, __payLinkSplitRedirect()__, __payLinkSplitSecondRedirect()__, __payLinkExpressRedirect()__ и т.д, они идут подряд. Еще в этих методах проходит проверка на валидность ссылки, стоит обратить на это ванимсние. В разметке тоже необходимо ввести кнопочки оплаты. Кнопочки можно найти по классу __"order__pay-button"__
 
## Запуск

- Склонировать репо-ии, затем: __npm install__ и __npm run dev__
- После первого запуска crm-poizzonq-api импортировать коллекции MongoDB, которые приложены к репо-ю и находятся в папке __mongoDB__
- В корне crm-poizzonq-api создать следующую структуру папок:
  ```
  ├── uploads
    ├── order-images
    ├── order-pay
    ├── order-purchase
    ├── order-receipt
  ```
- Запросить __.env__ файл
